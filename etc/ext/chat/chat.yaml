- name: scriptContent
  type: STRING
  value: |
    getChannel = { n ->
      if (!n.startsWith('#')) {
        throw failure("That is not a valid channel name")
      }
      return getAttr(extensionId, n, "Channel $n not found")
    }
    listChannels = {
      getAttrNames(extensionId, "No channels found").findAll {n -> n.startsWith('#')}
    }
    listChannelsWithMember = {m ->
      allChannelNames = listChannels()
      return allChannelNames.findAll(n -> {
        channel = getMembers(getChannel(n)).contains(m)
      })
    }
    getMembers = {c ->
      return c.getAttrListValueAsMap()['members'].getValue().split(',') as List
    }
    setMembers = {c, members ->
      newMembersAttr = newAttr('members', members.join(','))
      newAttrList = c.getAttrListValue().findAll {it -> !it.getName().equals('members')}
      newAttrList << newMembersAttr
      setAttr(extensionId, c.name, newAttrList)
    }
    runAsExtension()
    callerName = getCallerName()
    subcommand = arg0
    switch (subcommand.toUpperCase()) {
      case "SAY":
        channel = getChannel(arg1)
        members = getMembers(channel)
        if (!members.contains(callerName)) {
          throw failure("You do not belong to that channel")
        }
        for (m in members) {
          sendMessageTo(m, "[$channel.name] $callerName: $arg2")
        }
        break;
      case "JOIN":
        channel = getChannel(arg1)
        members = getMembers(channel)
        if (members.contains(callerName)) {
          sendMessageToCaller('You are already joined to that channel')
        } else {
          members.add(callerName)
          setMembers(channel, members)
        }
        break;
      case "LEAVE":
        channel = getChannel(arg1)
        members = getMembers(channel)
        if (!members.contains(callerName)) {
          sendMessageToCaller('You are not joined to that channel')
        } else {
          members.remove(callerName)
          setMembers(channel, members)
        }
        break;
      case "MINE":
        channels = listChannelsWithMember(callerName)
        sendMessageToCaller(channels.isEmpty() ? "No channels found" : channels.join(' '))
        break;
      case "LIST":
        channels = listChannels()
        sendMessageToCaller(channels.isEmpty() ? "No channels found" : channels.join(' '))
        break;
      case "MEMBERS":
        members = getMembers(getChannel(arg1))
        if (!members.contains(callerName)) {
          sendMessageToCaller('You are not joined to that channel')
        } else {
          sendMessageToCaller(members.isEmpty() ? "No members found" : members.join(' '))
        }
        break;
      default:
        throw failure("Unsupported command $subcommand")
    }
    return null
- name: scriptHelp
  type: ATTRLIST
  value: |
    - name: $CHAT
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT <subcommand> [<arguments>]
        - name: summary
          value: Interacts with the chat system
        - name: description
          value: "Available subcommands: say, join, leave, list, mine, members"
    - name: $CHAT_SAY
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT SAY <channel> <message>
        - name: summary
          value: Emits a message to all players in a channel
        - name: description
          value: Your player name is prepended to the message.
    - name: $CHAT_JOIN
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT JOIN <channel>
        - name: summary
          value: Joins a chat channel
        - name: description
          value: After joining a channel, you can say messages and see others' messages on it.
    - name: $CHAT_LEAVE
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT LEAVE <channel>
        - name: summary
          value: Leaves a chat channel
        - name: description
          value: After leaving a channel, you can no longer say messages or see others' messages on it.
    - name: $CHAT_LIST
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT LIST
        - name: summary
          value: List all chat channels
        - name: description
          value: Use this command to find channels to join.
    - name: $CHAT_MINE
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT MINE
        - name: summary
          value: List all chat channels you have joined
        - name: description
          value: These are channels you can say messages on and see others' messages on.
    - name: $CHAT_MEMBERS
      type: ATTRLIST
      value: |
        - name: syntax
          value: $CHAT MEMBERS <channel>
        - name: summary
          value: List the membership of a chat channel
        - name: description
          value: You must be a member of a channel to list its members.
